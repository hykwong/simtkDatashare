#! /usr/bin/perl

# Copyright 2020-2021, SimTK DataShare Team
#
# This file is part of SimTK DataShare. Initial development
# was funded under NIH grants R01GM107340 and U54EB020405
# and the U.S. Army Medical Research & Material Command award
# W81XWH-15-1-0232R01. Continued maintenance and enhancement
# are funded by NIH grant R01GM124443.

# ============================================================
# Creates a new release of the study data
# ============================================================
# Intended to be run by crontab nightly. Produces a new
# release when the data has changed.
# ------------------------------------------------------------

use lib qw( lib /usr/local/mobilizeds/lib );
use Mobilize;
use Mobilize::Study;
use Getopt::Long;

my $prefix = $Mobilize::Conf->{ prefix };
#my $study  = $Mobilize::Conf->{ study }{ id };
my $study  = "study10";
my $policy = $Mobilize::Conf->{ cleanup }{ releases }{ keep };

our $check = 0;
GetOptions( "check|c" => \$check );

for (my $study=1; $study <= 50; $study++) {

  my $token =  "$prefix/data/$study.need-new-snapshot";

  if( ! $check || -e $token ) {
	my $study   = new Mobilize::Study( $study );
	my $release = $study->release( $policy );
	unlink $token;
  }

}
